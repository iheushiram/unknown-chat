version: '3.8'

services:
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://127.0.0.1:8787
      - NEXT_PUBLIC_WS_URL=ws://127.0.0.1:8787
    volumes:
      - ./apps/frontend:/app
      - ./packages:/packages
      - /app/node_modules
      - /packages/shared/node_modules
      - /packages/ui/node_modules
      - /packages/crypto/node_modules
    depends_on:
      - backend
    networks:
      - unknown-chat-network
    command: pnpm dev

  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    ports:
      - '8787:8787'
      - '9229:9229' #デバッグ用
    environment:
      - NODE_ENV=development
      - CLOUDFLARE_ACCOUNT_ID=${CLOUDFLARE_ACCOUNT_ID}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      - DATABASE_URL=./dev.db
      - JWT_SECRET=dev_jwt_secret_key_12345
      - ENCRYPTION_KEY=dev_encryption_key_12345
    volumes:
      - ./apps/backend:/app
      - ./packages:/packages
      - /app/node_modules
      - /packages/shared/node_modules
      - /packages/crypto/node_modules
      - unknown-chat-db:/root/.wrangler/state/v3
    networks:
      - unknown-chat-network
    command: pnpm dev

  db-studio:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    ports:
      - '4983:4983' # Drizzele Studio
    environment:
      - NODE_ENV=development
      - DATABASE_URL=./dev.db
    volumes:
      - ./apps/backend:/app
      - unknown-chat-db:/app/.wrangler
    networks:
      - unknown-chat-network
    command: pnpm db:studio
    depends_on:
      - backend
    profiles:
      - tools

volumes:
  unknown-chat-db:
    driver: local

networks:
  unknown-chat-network:
    driver: bridge
